---
name: plan-review
description: |
  AUTO-TRIGGER ONLY: Activate automatically when the user has just approved a
  plan from ExitPlanMode. After plan approval, immediately begin reviewing the
  plan step-by-step WITHOUT waiting for any further user instruction — similar
  to how the `open` skill fires automatically after Claude generates a visual
  file. Do NOT activate in any other context.
version: 1.1.0
tools: Read, Glob, Edit
---

# plan-review スキル

## 概要

planモードで提示された長大なプランを**最小単位の決定事項**に自動分解し、ユーザーが一つずつ「この方針でいいか」を確認・承認するためのスキル。

変更が承認された決定事項は、**その場でプランファイルに即座に反映する**（Edit ツールで書き込み）。

## 適用条件

このスキルはplanモードの `ExitPlanMode` 後、ユーザーがプランを承認した瞬間に自動起動する。ユーザーは何も入力不要。

## 実行手順

### フェーズ1: プランファイルの読み込み

1. `Glob` で `~/.claude/plans/` 内のファイルを特定する（更新日時が最新のものを使用）
2. ファイルが複数ある場合はファイル名一覧を表示してユーザーに選ばせる:

```
以下のプランファイルが見つかりました:
  1. snug-baking-lobster.md (2025-01-20 14:32)
  2. happy-coding-panda.md (2025-01-19 09:15)

確認するプランの番号を入力してください:
```

3. `Read` でプランファイルを全文読み込む

### フェーズ2: 決定事項への分解

プランを**最小単位の決定事項**に分解する。

**分解の基準:**
> **「この方針でいいですか？」という問いに y/n で答えられる単位**

一つの決定事項が複数の選択・判断を含んでいたら、さらに細かく分割する。

**分解例（note-postプランの場合）:**
```
決定1: スキル名を "note-post" にする
決定2: 投稿方法として BrowserMCP を使用する（非公式APIは使わない）
決定3: 記事生成は Claude 自身が直接行う（外部 Claude API 呼び出しは不要）
決定4: ログイン自動化は行わない（事前ブラウザログインを必須とする）
決定5: カバー画像アップロードは手動操作とする
決定6: 記事の目標文字数を 1,500〜2,500 字に設定する
決定7: タグに "AIものづくり" を必須タグとして常に含める
決定8: 設定情報（ユーザー名・価格等）を CLAUDE.md に保存する
…
```

→ プランが長いほど決定事項は増える。迷ったらより細かく分割する。

### フェーズ3: ステップバイステップ確認

#### 全件一覧の表示

まず全決定事項の一覧を表示して全体像を把握させる:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
プラン確認: note-post スキル作成（全15件）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. スキル名を "note-post" にする
  2. 投稿に BrowserMCP を使用する
  3. 記事生成は Claude 自身が直接行う
  4. ログイン自動化は行わない
  5. カバー画像アップロードは手動操作とする
  6. 記事の目標文字数を 1,500〜2,500 字に設定する
  7. タグに "AIものづくり" を必須タグとして含める
  8. 設定情報を CLAUDE.md に保存する
  ...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
一つずつ確認します。y で承認 / その他で変更・却下・中断
```

#### 各決定事項の確認

その後、各決定事項を1件ずつ**シンプルな一問一答**で提示する:

```
確認 3/15

記事生成は Claude 自身が直接行います。
別途 Claude API を呼び出すのではなく、Claude Code の Claude が直接記事本文を生成します。
理由: Claude Code のセッション内にすでに Claude が存在しているため外部 API 呼び出しは不要です。API キーの管理コストをゼロにできます。

こちらを承認しますか？
```

**フォーマット原則:**
- **内容を全文表示する**: 「設定を追加」ではなく具体的な値・方針を明示する
- **理由・方針は必須**: なぜその選択をしたか、代替案を選ばなかった理由も含める
- **進捗を常に表示**: "確認 N/X" をヘッダーに必ず入れる

#### 入力のハンドリング

| 入力 | 動作 |
|------|------|
| `y` / `yes` / `はい` | 承認として記録 → 次の決定事項へ |
| `n` / `no` / `いいえ` | 却下として記録 → 「どのように変更しますか？」と聞く → 修正案を提示 → 再確認 |
| 自由記述 | 変更指示として扱う → 変更案を提示 → 「こちらを承認しますか？」と再確認 |
| `q` / `quit` / `中止` | 確認を中断。その時点までの結果集計を表示 |

#### 変更承認時のプランファイル即時更新

ユーザーが変更案を承認した場合、**その場で `Edit` ツールを使ってプランファイルを更新する**。次の決定事項に進む前に書き込みを完了させること。

```
変更案が承認された場合の流れ:
  1. ユーザーが変更案に `y` と回答
  2. Edit ツールでプランファイルの該当箇所を更新
  3. 次の決定事項を表示
```

これにより、レビュー完了時にはプランファイルがすべての変更を反映済みの状態になる。レビュー後にまとめて書き込む必要はない。

**短い入力を受け入れる**: `y` 一文字で承認できる設計を維持する。

#### n / 変更指示の処理例

```
確認 4/15

ログイン自動化は行いません。
ユーザーが事前にブラウザでログインしておくことを前提とします。
理由: ログイン自動化はサービス利用規約に抵触する可能性があるため。

こちらを承認しますか？
> 自動ログインをサポートしたい

承知しました。変更案を提示します:

【変更案】
ログインページを自動的に開き、フォームへの入力をアシストします。
ただし、最終的なログインボタンのクリックはユーザーが手動で行う「半自動化」とします。

こちらを承認しますか？
```

#### 全件完了後の集計表示

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
確認完了: 承認 13件 / 変更 2件 / 却下 0件
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
変更した決定事項:
  #4 ログイン: 手動→スクリプトでのログイン補助に変更
  #8 CLAUDE.md: 別ファイル(.note-config)に分離

プランの確認が完了しました。
変更事項があれば実装前にプランファイルを更新してください。
```

## 注意事項

- **コード実装はしない**: このスキルはプランの確認とプランファイルの更新のみ行う。Write / Bash は呼び出さない
- **使用ツール**: `Read`, `Glob`, `Edit`（プランファイルの更新用）のみ使用する
- **変更は即時反映**: 変更案が承認されたら、次の決定事項に進む前にプランファイルを Edit で更新する
- **一件ずつ表示**: 複数の決定事項をまとめて表示しない。必ず一件ずつ提示する
- **プランが見つからない場合**: `~/.claude/plans/` にファイルが存在しない場合は「プランファイルが見つかりません。`~/.claude/plans/` にプランファイルを保存してから再試行してください。」と伝えて終了する
